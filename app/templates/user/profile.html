{% extends "base.html" %}

{% block title %}个人资料 - 美食点评网{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 左侧导航栏 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <img src="{{ url_for('static', filename='images/avatar-placeholder.png') }}" 
                         class="rounded-circle mb-3" 
                         width="150" 
                         height="150"
                         alt="用户头像">
                    <h5 id="profile-username">{{ user.name }}</h5>
                    <p class="text-muted" id="profile-email">{{ user.email }}</p>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#profile-info">基本信息</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#reviews">我的点评</a>
                        </li>
                        {% if user.type == 'business' %}
                        <li class="nav-item">
                            <a class="nav-link" href="/my-restaurants">我的餐厅</a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link" href="/settings">账号设置</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 右侧内容区 -->
        <div class="col-md-9">
            <!-- 基本信息卡片 -->
            <div class="card mb-4" id="profile-info">
                <div class="card-header">
                    <h5>基本信息</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>用户ID：</strong> <span id="user-id">{{ user.user_id }}</span></p>
                            <p><strong>注册时间：</strong> <span id="join-date">{{ user.created_at }}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>用户类型：</strong> 
                                <span class="badge bg-{{ 'primary' if user.type == 'business' else 'success' }}">
                                    {{ '商家用户' if user.type == 'business' else '普通用户' }}
                                </span>
                            </p>
                            <p><strong>最后登录：</strong> <span id="last-login">{{ user.last_login or '首次登录' }}</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 最近点评 -->
            <div class="card mb-4" id="reviews">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>我的点评</h5>
                    <a href="/my-reviews" class="btn btn-sm btn-outline-primary">查看全部</a>
                </div>
                <div class="card-body">
                    <div id="reviews-list">
                        <!-- 动态加载点评内容 -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商家专属面板 -->
            {% if user.type == 'business' %}
            <div class="card mb-4" id="business-stats">
                <div class="card-header">
                    <h5>商家数据</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h3 id="restaurant-count">0</h3>
                            <p class="text-muted">管理的餐厅</p>
                        </div>
                        <div class="col-md-4">
                            <h3 id="average-rating">0.0</h3>
                            <p class="text-muted">平均评分</p>
                        </div>
                        <div class="col-md-4">
                            <h3 id="total-reviews">0</h3>
                            <p class="text-muted">总点评数</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 从JWT或本地存储获取用户ID
    const userId = localStorage.getItem('userId');
    if (!userId) {
        window.location.href = '/login';
        return;
    }

    // 加载用户资料
    fetchUserProfile(userId);
    
    // 加载用户点评
    fetchUserReviews(userId);

    // 如果是商家用户，加载商家数据
    if (document.getElementById('business-stats')) {
        fetchBusinessStats(userId);
    }

    function fetchUserProfile(userId) {
        axios.get(`/api/users/${userId}`)
            .then(response => {
                // 更新DOM
                document.getElementById('profile-username').textContent = response.data.name;
                document.getElementById('profile-email').textContent = response.data.email;
                document.getElementById('user-id').textContent = response.data.user_id;
                document.getElementById('join-date').textContent = new Date(response.data.created_at).toLocaleString();
                document.getElementById('last-login').textContent = response.data.last_login ? 
                    new Date(response.data.last_login).toLocaleString() : '首次登录';
            })
            .catch(error => {
                console.error('获取用户资料失败:', error);
                alert('加载资料失败，请刷新重试');
            });
    }

    function fetchUserReviews(userId) {
        axios.get(`/api/users/${userId}/reviews?limit=3`)
            .then(response => {
                const reviewsList = document.getElementById('reviews-list');
                reviewsList.innerHTML = '';
                
                if (response.data.length === 0) {
                    reviewsList.innerHTML = '<p class="text-muted">暂无点评记录</p>';
                    return;
                }

                response.data.forEach(review => {
                    const reviewElement = `
                        <div class="mb-3 p-3 border-bottom">
                            <div class="d-flex justify-content-between">
                                <h6><a href="/restaurants/${review.restaurant_id}">${review.restaurant_name}</a></h6>
                                <div class="text-warning">
                                    ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                                </div>
                            </div>
                            <p class="mb-1">${review.content || '暂无详细评价'}</p>
                            <small class="text-muted">${new Date(review.created_at).toLocaleString()}</small>
                        </div>`;
                    reviewsList.insertAdjacentHTML('beforeend', reviewElement);
                });
            })
            .catch(error => {
                console.error('获取点评失败:', error);
                document.getElementById('reviews-list').innerHTML = 
                    '<p class="text-danger">加载点评失败</p>';
            });
    }

    function fetchBusinessStats(userId) {
        axios.get(`/api/business/${userId}/stats`)
            .then(response => {
                document.getElementById('restaurant-count').textContent = response.data.restaurant_count;
                document.getElementById('average-rating').textContent = response.data.average_rating.toFixed(1);
                document.getElementById('total-reviews').textContent = response.data.total_reviews;
            })
            .catch(error => {
                console.error('获取商家数据失败:', error);
            });
    }
});
</script>
{% endblock %}