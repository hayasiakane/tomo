{% extends "base.html" %}
{% block title %}ç¼–è¾‘èµ„æ–™ - TOMOé£Ÿå…‰{% endblock %}

{% block content %}
<style>
  body {
    background-color: #fef1e3;
  }

  .edit-card {
    background: #ffa726;
    border-radius: 8px;
    padding: 30px;
    max-width: 600px;
    margin: 0 auto 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    color: #fff;
  }

  .edit-card h3 {
    margin-bottom: 24px;
    color: #fff;
  }

  .form-label {
    color: #fff;
  }

  .form-control, .form-select {
    border: 1px solid #ffffff;
    background: #fff;
    color: #333;
  }

  .form-control::placeholder {
    color: #999;
  }

  .form-control:focus, .form-select:focus {
    border-color: #fff;
    box-shadow: none;
  }

  .btn-save {
    background-color: #fef1e3;
    font-weight: bold;
    border: none;
    padding: 8px 20px;
    border-radius: 6px;
  }

  .btn-save:hover {
    background: #ffe6e0;
  }

  .form-text {
    color: rgba(255,255,255,0.8);
  }

  input[readonly], .readonly-box {
    border: none;
    background: transparent;
    color: #fff;
    padding-left: 0;
    font-size: 0.95rem;
  }
</style>

<div class="container py-5">
  <div class="edit-card">
    <h3 class="text-center">ç¼–è¾‘ä¸ªäººèµ„æ–™</h3>
    <form id="profileForm">
      <div class="mb-3">
        <label for="inputName" class="form-label">æ˜µç§°</label>
        <input type="text" class="form-control" id="inputName" placeholder="è¯·è¾“å…¥æ˜µç§°">
      </div>

      <div class="mb-3">
        <label class="form-label">é‚®ç®±</label>
        <div id="inputEmail" class="readonly-box">(æœªè®¾ç½®)</div>
      </div>

      <div class="mb-3">
        <label for="inputJoined" class="form-label">åŠ å…¥æ—¶é—´</label>
        <input type="text" id="inputJoined" readonly class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">åå¥½æ ‡ç­¾</label>
        <select multiple class="form-select" id="selectTags">
          <option>ğŸ° ç”œå“</option>
          <option>â˜•ï¸ å’–å•¡</option>
          <option>ğŸ¥˜ ç«é”…</option>
          <option>ğŸœ é¢æ¡</option>
          <option>ğŸ£ å¯¿å¸</option>
          <option>ğŸ” æ±‰å ¡</option>
        </select>
        <div class="form-text">æŒ‰ä½ Ctrl æˆ– Command å¤šé€‰</div>
      </div>

      <div class="d-flex justify-content-end mt-4">
        <button type="submit" class="btn btn-save">ä¿å­˜ä¿®æ”¹</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const userId = localStorage.getItem("userId");
  if (!userId) return window.location.href = "/login";

  const profileKey = `profileData_${userId}`;
  const joinedKey = `joined_${userId}`;
  const nameKey = `username_${userId}`;

  const localData = JSON.parse(localStorage.getItem(profileKey) || '{}');
  const joined = localStorage.getItem(joinedKey) || new Date().toISOString().split("T")[0];
  document.getElementById("inputJoined").value = joined;
  document.getElementById("inputName").value = localData.name || localStorage.getItem(nameKey) || "";

  const select = document.getElementById("selectTags");
  const savedTags = localData.tags || ["ğŸ° ç”œå“"];
  Array.from(select.options).forEach(opt => {
    if (savedTags.includes(opt.text)) opt.selected = true;
  });

  axios.get(`/api/users/${userId}`).then(res => {
    const user = res.data;
    const email = user.email || "ï¼ˆæœªè®¾ç½®ï¼‰";
    document.getElementById("inputEmail").textContent = email;
    localStorage.setItem(`email_${userId}`, email);
  });

  document.getElementById("profileForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const name = document.getElementById("inputName").value.trim();
    const tags = Array.from(select.selectedOptions).map(opt => opt.text);
    const email = localStorage.getItem(`email_${userId}`) || "ï¼ˆæœªè®¾ç½®ï¼‰";

    const updated = { name, email, joined, tags };
    localStorage.setItem(profileKey, JSON.stringify(updated));
    localStorage.setItem(nameKey, name);
    localStorage.setItem(joinedKey, joined);

    // âœ… æ–°å¢ï¼šåŒæ­¥æ›´æ–°æ˜µç§°åˆ°æ•°æ®åº“
    axios.put("/api/users/update", {
      userId: userId,
      name: name
    }).then(() => {
      window.location.href = "/profile.html"; // æˆåŠŸåè·³è½¬
    }).catch(err => {
      alert("ä¿®æ”¹å¤±è´¥ï¼š" + (err.response?.data?.error || err.message));
    });
  });
});
</script>
{% endblock %}